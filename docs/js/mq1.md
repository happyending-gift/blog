---
title: mq
author: chengp
---

## 三大消息队列区别

以下是Kafka、RocketMQ 和 RabbitMQ 三种常见消息队列的对比：

| 特性 | Kafka | RocketMQ | RabbitMQ |
| --- | --- | --- | --- |
| 吞吐量 | 高 | 高 | 中等 |
| 死信队列 | × | √ | √ |
| 延迟队列 | × | √ | √ |
| 优先级队列 | × | √ | √ |
| 消息获取 | 拉 | 推/拉 | 推/拉 |
| 支持事务 | 仅消息生产事务 | 支持 | 支持 |


## MQ 消息丢失问题及解决方案

在消息队列（MQ）的使用过程中，消息丢失是一个需要特别注意的问题。以下是消息在不同阶段可能丢失的原因以及相应的解决方案：

### 信息到 MQ

在这个阶段，消息从生产者发送到消息队列的过程中可能会丢失。

解决方案：

- **发送方确认模式**：确保消息被成功发送到消息队列。例如，在 RabbitMQ 中，可以通过设置 `mandatory` 标志来实现。如果消息无法被路由到任何队列，RabbitMQ 会发送一个 `return` 消息到指定的交换机。
- **事务支持**：使用事务来确保消息的发送和确认。例如，在 Kafka 中，可以通过 `acks` 参数来控制消息的确认机制。

### 信息路由到队列

在这个阶段，消息在被路由到特定队列的过程中可能会丢失。

解决方案：

- **路由失败通知**：在 RabbitMQ 中，可以在配置新的 `RabbitTemplate` 时开启路由失败通知。这样，如果消息无法被路由到任何队列，将会触发一个回调函数。
- **监控和报警**：设置监控和报警机制，以便在路由失败时及时得到通知。

### 消息在队列正确存储

在这个阶段，消息已经到达队列，但在存储过程中可能会丢失。

 解决方案：
- **持久化配置**：确保交换机、队列和消息都被设置为持久化。例如，在 RabbitMQ 中，可以通过设置 `durable` 属性来实现队列的持久化，以及通过 `deliveryMode` 来设置消息的持久化。
- **备份和复制**：使用队列的备份和复制机制来提高数据的可靠性。

### 队列投递到消费者

在这个阶段，消息从队列投递到消费者的过程中可能会丢失。

 解决方案：

- **消费者确认**：确保消费者在处理完消息后进行确认。例如，在 RabbitMQ 中，可以通过设置手动提交（`manual` 或 `manualAckNow`）来实现。
- **监听容器**：使用监听容器来异步接收消息，并在确认消息后进行处理。
- **绑定队列**：正确绑定队列和消费者，确保消息能够被正确投递。
- **定义消费者确认方法**：在消费者中定义确认方法，确保在消息处理成功后进行确认。

